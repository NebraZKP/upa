# Full UPA Benchmarks
To benchmark proving times for all three circuits (Universal Batch Verifier, Variable-Length Keccak, Universal Outer) for a given `UpaConfiguration`, use the `upa` benchmark.

## Configs
This benchmark takes configurations from `/benches/configs/universal_outer_configs.json` and reports the proving times and circuit sizes for all three circuits. Configurations can be entered by hand or generated by the `fn write_upa_configs_fixed_size` in `/benches/configs/utils.rs`.

## Benching
Once the desired configurations are specified, the benchmarks can be run using `cargo bench --bench upa`. For example, to run the benchmarks with the GPU feature enabled and direct the logs to a file `upa_benchmark.log`:

```
cargo bench --bench upa --features gpu 2>&1 | tee upa_benchmark.log
```

## Parsing
The resulting log can be parsed to CSV format with the log parsing script located at `/benches/log_parsing/upa_log_parser.py`. Note that this script is only intended to work for the `upa` benchmark log. The usage is

```
python upa_log_parser.py upa_benchmark.log upa_benchmarks
```
Here `upa_benchmarks` is the base filename for the parsed CSV output. This command produces three files:
- `upa_benchmarks_raw.csv` containing a row for each circuit that was timed during the benchmark, including duplicate configurations
- `upa_benchmarks_combined.csv` where the results of identical configurations are averaged for each circuit
- `upa_benchmarks_processed.csv` which reports all measurements for a given UPA configuration in each row. This file is intended to be the most readable.

### Fragmented Log Files
The benchmark sometimes fails and needs to be restarted without the bad configurations. This can result in fragmented benchmark logs. A script at `benches/log_parsing/concatenate_files.py` can be used to concatenate two or more benchmark log files. The command
```
python concatenate_files.py output_filename input_1.log input_2.log input_3.log
```
produces a text file at `output_filename` containing the concatenated contents of the `input_i.log` files. The command accepts any number (>1) of input files.

# Individual Circuit Benchmarks
The three UPA circuits: batch verifier, keccak, and outer can be benchmarked individually instead. The files in the `configs` folder include the default configurations, but they can be changed to measure other combinations.

## Measured quantities
For the three circuits, the benchmarks will run for the chosen configurations. For each config, it will return:
- The gate config, i.e., the number of advice, lookup and fixed columns the circuit has
- The proving time

The keccak benchmark will also print
- The number of keccak columns.
The keccak benchmark may fail if the configuration is too wide, i.e. the number of advice, lookup and keccak columns is too high. In that case the benchmark itself won't run and it won't print the proving time. It will continue to the next configuration in the file.

The outer benchmark will also print
- The gas cost per proof.
If the configuration is such that the verifier contract is too large to deploy, it will fail and continue to the next configuration in the file.

## Run the UPA benchmarks
In order to run the UPA benchmarks, use the following command:
```
cargo bench --bench benchmark_name
```
where `benchmark_name` can be `batch_verify`, `keccak` and `outer`.
By default, the command above runs the benchmarks on a CPU. If you want to run the benchmarks on a GPU, do
```
cargo bench --features gpu --bench benchmark_name
```
instead.

For the keccak circuit, one can bench the variable length keccak circuit by setting an environment variable as follows
```
KECCAK_INPUT_TYPE=VAR cargo bench --bench keccak
```
with or without the `--features gpu` flag.

## Create config files
The `utils` file contains some config generation utilities. In order to generate configs for a particular circuit, find
the corresponding `write_circuit_configs` function in the file, where `circuit` can be `bv`, `keccak` and `outer`. Then modify
all the range vectors to include the values you want to create.
For example, if you write the following lines in `write_bv_configs`:
```rust
let degree_range: Vec<u32> = vec![18, 19, 20];
let batch_range: Vec<u32> = vec![8, 16];
```
it is going to create a `bv_configs.json` file with 6 configurations, namely all possible combinations of the three degree values with the two batch size values.

After modifying the function, to write the file run:
```
cargo test --package upa-circuits --bench utils -- write_bv_configs --exact --nocapture
```
or
```
cargo test --package upa-circuits --bench utils -- write_keccak_configs --exact --nocapture
```
```
cargo test --package upa-circuits --bench utils -- write_outer_configs --exact --nocapture
```
for the other circuits.
